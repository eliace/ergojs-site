<!DOCTYPE html>

<html lang="en">
<head>
	<meta charset="utf-8">
	<title>Documentation Source: core/states.js</title>

	<!--[if lt IE 9]>
	<script src="//html5shiv.googlecode.com/svn/trunk/html5.js"></script>
	<![endif]-->
	<link type="text/css" rel="stylesheet" href="styles/sunlight.default.css">

	
	<link type="text/css" rel="stylesheet" href="styles/site.spacelab.css">
	
</head>

<body>
<div class="container-fluid">
	<div class="navbar navbar-fixed-top ">
		<div class="navbar-inner">
			<a class="brand" href="index.html">Documentation</a>
			<ul class="nav">
				
				<li class="dropdown">
					<a href="namespaces.list.html" class="dropdown-toggle" data-toggle="dropdown">Namespaces<b
						class="caret"></b></a>

					<ul class="dropdown-menu ">
						
						<li>
							<a href="Ergo.html">Ergo</a>
						</li>
						
						<li>
							<a href="Ergo.core.html">core</a>
						</li>
						
						<li>
							<a href="Ergo.data.html">data</a>
						</li>
						
						<li>
							<a href="Ergo.events.html">events</a>
						</li>
						
						<li>
							<a href="Ergo.html.html">html</a>
						</li>
						
						<li>
							<a href="Ergo.layouts.html">layouts</a>
						</li>
						
						<li>
							<a href="Ergo.widgets.html">widgets</a>
						</li>
						

					</ul>
				</li>
				
				<li class="dropdown">
					<a href="classes.list.html" class="dropdown-toggle" data-toggle="dropdown">Classes<b
						class="caret"></b></a>

					<ul class="dropdown-menu ">
						
						<li>
							<a href="Ergo.core.Array.html">Array</a>
						</li>
						
						<li>
							<a href="Ergo.core.Collection.html">Collection</a>
						</li>
						
						<li>
							<a href="Ergo.core.Context.html">Context</a>
						</li>
						
						<li>
							<a href="Ergo.core.DataSource.html">DataSource</a>
						</li>
						
						<li>
							<a href="Ergo.core.Layout.html">Layout</a>
						</li>
						
						<li>
							<a href="Ergo.core.Object.html">Object</a>
						</li>
						
						<li>
							<a href="Ergo.core.StateManager.html">StateManager</a>
						</li>
						
						<li>
							<a href="Ergo.core.Widget.html">Widget</a>
						</li>
						
						<li>
							<a href="Ergo.core.WidgetArray.html">WidgetArray</a>
						</li>
						
						<li>
							<a href="Ergo.data.Collection.html">Collection</a>
						</li>
						
						<li>
							<a href="Ergo.data.Object.html">Object</a>
						</li>
						
						<li>
							<a href="Ergo.events.Dispatcher.html">Dispatcher</a>
						</li>
						
						<li>
							<a href="Ergo.events.Event.html">Event</a>
						</li>
						
						<li>
							<a href="Ergo.html.Button.html">Button</a>
						</li>
						
						<li>
							<a href="Ergo.html.Iframe.html">Iframe</a>
						</li>
						
						<li>
							<a href="Ergo.html.Img.html">Img</a>
						</li>
						
						<li>
							<a href="Ergo.html.Input.html">Input</a>
						</li>
						
						<li>
							<a href="Ergo.html.Select.html">Select</a>
						</li>
						
						<li>
							<a href="Ergo.html.Textarea.html">Textarea</a>
						</li>
						
						<li>
							<a href="Ergo.html.Widget.html">Widget</a>
						</li>
						
						<li>
							<a href="Ergo.widgets.Box.html">Box</a>
						</li>
						
						<li>
							<a href="Ergo.widgets.Button.html">Button</a>
						</li>
						
						<li>
							<a href="Ergo.widgets.Check.html">Check</a>
						</li>
						
						<li>
							<a href="Ergo.widgets.Field.html">Field</a>
						</li>
						
						<li>
							<a href="Ergo.widgets.Icon.html">Icon</a>
						</li>
						
						<li>
							<a href="Ergo.widgets.Inline.html">Inline</a>
						</li>
						
						<li>
							<a href="Ergo.widgets.Link.html">Link</a>
						</li>
						
						<li>
							<a href="Ergo.widgets.List.html">List</a>
						</li>
						
						<li>
							<a href="Ergo.widgets.NestedList.html">NestedList</a>
						</li>
						
						<li>
							<a href="Ergo.widgets.Panel.html">Panel</a>
						</li>
						
						<li>
							<a href="Ergo.widgets.Table.html">Table</a>
						</li>
						
						<li>
							<a href="Ergo.widgets.TableRow.html">TableRow</a>
						</li>
						
						<li>
							<a href="Ergo.widgets.Text.html">Text</a>
						</li>
						

					</ul>
				</li>
				
				<li class="dropdown">
					<a href="mixins.list.html" class="dropdown-toggle" data-toggle="dropdown">Mixins<b
						class="caret"></b></a>

					<ul class="dropdown-menu ">
						
						<li>
							<a href="Ergo.Observable.html">Observable</a>
						</li>
						
						<li>
							<a href="Ergo.Statable.html">Statable</a>
						</li>
						
						<li>
							<a href="Ergo.WidgetOptions.html">WidgetOptions</a>
						</li>
						

					</ul>
				</li>
				
				<li class="dropdown">
					<a href="global.html" class="dropdown-toggle" data-toggle="dropdown">Global<b
						class="caret"></b></a>

					<ul class="dropdown-menu ">
						
						<li>
							<a href="global.html#apply_all">apply_all</a>
						</li>
						
						<li>
							<a href="global.html#clear">clear</a>
						</li>
						
						<li>
							<a href="global.html#each">each</a>
						</li>
						
						<li>
							<a href="global.html#filter">filter</a>
						</li>
						
						<li>
							<a href="global.html#find">find</a>
						</li>
						
						<li>
							<a href="global.html#find_all">find_all</a>
						</li>
						
						<li>
							<a href="global.html#get">get</a>
						</li>
						
						<li>
							<a href="global.html#has_key">has_key</a>
						</li>
						
						<li>
							<a href="global.html#includes">includes</a>
						</li>
						
						<li>
							<a href="global.html#is_empty">is_empty</a>
						</li>
						
						<li>
							<a href="global.html#key_of">key_of</a>
						</li>
						
						<li>
							<a href="global.html#keys">keys</a>
						</li>
						
						<li>
							<a href="global.html#map">map</a>
						</li>
						
						<li>
							<a href="global.html#remove">remove</a>
						</li>
						
						<li>
							<a href="global.html#remove_at">remove_at</a>
						</li>
						
						<li>
							<a href="global.html#remove_if">remove_if</a>
						</li>
						
						<li>
							<a href="global.html#set">set</a>
						</li>
						
						<li>
							<a href="global.html#size">size(1)</a>
						</li>
						

					</ul>
				</li>
				
			</ul>
		</div>
	</div>

	<div class="row-fluid">

		
			<div class="span12">
				
				<div id="main">
					


		<h1 class="page-title">Source: core/states.js</h1>
    
    <section>
        <article>
            <pre class="sunlight-highlight-javascript ">
//= require "events"



/**
 * Менеджер состояний
 * 
 * 
 * @class
 * @name Ergo.core.StateManager
 * @extends Ergo.core.Object
 */
Ergo.declare('Ergo.core.StateManager', 'Ergo.core.Object', /** @lends Ergo.core.StateManager.prototype */{
	
	
	_initialize: function(widget) {
		this._widget = widget;
		this._current = {};
		this._states = {};
		this._transitions = [];
		this._exclusives = {};
	},
	
	
	transition: function(from, to, value) {
		
		var t = this._transitions;
//		var s = name.replace(/\s/g, '');
//		if(!t[from]) t[from] = {};
//		t[from][to] = value;
		t.push({
			from: from,
			to: to,
			action: value
		});
		
	},
	
	
	exclusive: function(name, g) {
		
//		var excl_template = new RegExp('^'+name+'.*$');
		var excl_template = new RegExp('^'+name+'$');

		var group = this._exclusives[g];
		if(!group) group = [];
		this._exclusives[g] = group;
		
		group.push(excl_template);		
	},
	
	exclusive_group: function(g, exclusives) {		
		for(var i = 0; i &lt; exclusives.length; i++)
			this.exclusive(exclusives[i], g);
	},
	
	
	
	state: function(name, value) {
		
		// парсим код состояния
		var i = name.indexOf(':');
		if( i == 0 ) {
			var g = name.substr(1);
			this.exclusive_group(g, value);
		}
		else {
			if( i > 0 ) {
				var g = name.substr(i+1);
				name = name.substr(0, i);
				
				this.exclusive(name, g);
			}
		
			this._states[name] = value;
		}
	},
	
	
	
	/**
	 * Установка состояния
	 *  
	 * @param {String} to имя состояния
	 * @param {Object} data данные, связанные с состоянием
	 * @returns {$.Deferred}
	 */
	set: function(to, data) {
		
		// Если состояние уже установлено, то ничего не делаем
		if(to && (to in this._current))
			return $.when({});

		
		
		var self = this;
		var transitions = this._transitions;
		var states = this._states;//this._widget.options.states;
		
		var from = [];
		
		// 1.
		var def = null;
		var deferreds = [];
		
		for(var i = 0; i &lt; transitions.length; i++) {
			var t = transitions[i];
			if(t.to == to && t.from in this._current) {
				var result = t.action.call(this._widget);
				// Если результат является Deferred-объектом, то сохраняем его в цепочку
//				if(result && result.done)
				deferreds.push(result);
//					deferred = deferred ? $.when(deferred, result) : $.when(result);
				
				from.push(t.from);
			}
			else if(t.to == to && t.from == '*'){
				def = t;
			}
		} 
		// for(var i in this._current) {
			// if(i in transitions && to in transitions[i]) {
				// transitions[i][to].call(this._widget);
				// from.push(i);
			// }
		// }
		
		for(var g in this._exclusives) {
			if( this._is_exclusive(to, g) ) {
				
				for(var i in this._current)
					if(this._is_exclusive(i, g))
						this.unset(i);
				
			}			
		}
		
		
		
		
		
		if(from.length == 0 && def) {
			var result = def.action.call(this._widget);
			
//			if(result && result.done)
			deferreds.push(result);
//				deferred = $.when(result);
		}
		


		
		
		// if(deferreds.length == 0)
			// deferreds.push({});
		
		
		//FIXME хак, если Deferred не определен
		// if(deferred == null) {
			// deferred = $.Deferred();
			// deferred.resolve();
		// }		
		
		
		
		return $.when.apply($, deferreds).done(function() {
			
			// 2. удаляем все исходные состояния переходов из списка активных состояний
			for(var i = 0; i &lt; from.length; i++) {
				delete self._current[from[i]];
			}			
			
			// 3. включаем итоговое состояние
			self._state_on(to, data);
			self._current[to] = from;
			
			// 4. оповещаем виджет, что состояние изменилось
			self._widget.events.fire('stateChanged', {from: from, to: to, data: data});
			
		});
		
//		return deferred;
	},
	
	
	
	_state_on: function(s, data) {
		
		var self = this;
		var states = this._states;//this._widget.options.states;
		
		if(s in states) {
			var val = states[s];
			
			// если состояние определено строкой, то строка содержит имя устанавливаемого класса
			if($.isString(val))
				this._widget.el.addClass(val);
			// если состояние определено массивом, то первый элемент содержит состояние ON, а второй элемент состояние OFF
			else if($.isArray(val)) {
				if(val.length > 0) {
					$.when( val[0].call(this._widget, true, data) ).done(function(add_cls) {
						if(add_cls !== false)				
							self._widget.el.addClass(add_cls || s);					
					});
				}
			}
			// в иных случаях ожидается, что состояние содержит функцию
			else {
				$.when( val.call(this._widget, true, data) ).done(function(add_cls) {
					if(add_cls !== false)				
						self._widget.el.addClass(add_cls || s);					
				});
			}
		}
		else {
			this._widget.el.addClass(s);
		}

		this._widget.events.fire('stateChanged', {state: s, op: 'on', data: data});		
	},
	
	
	
	
	
	_state_off: function(s) {

		var self = this;
		var states = this._states;//this._widget.options.states;
		
		if(s in states) {
			var val = states[s];
			
			// если состояние определено строкой, то строка содержит имя устанавливаемого класса			
			if($.isString(val))
				this._widget.el.removeClass(val);
			// если состояние опрелено массивом, то первый элемент содержит состояние ON, а второй элемент состояние OFF
			else if($.isArray(val)) {
				if(val.length > 1) {
					$.when( val[1].call(this._widget, false) ).done(function(rm_cls) {
						if(rm_cls !== false)
							self._widget.el.removeClass(rm_cls || s);					
					});					
				}
			}
			// в иных случаях ожидается, что состояние содержит функцию
			else {
				$.when( val.call(this._widget, false) ).done(function(rm_cls) {
					if(rm_cls !== false)				
						self._widget.el.removeClass(rm_cls || s);
				});
				
//				var rm_cls = val.call(this._widget, false);
//				if(rm_cls !== false)				
//					this._widget.el.removeClass(s);				
			}
		}
		else {
			this._widget.el.removeClass(s);
		}		
		
		this._widget.events.fire('stateChanged', {state: s, op: 'off'});
				
	},
	
	
	
	_is_exclusive: function(s, g) {
		
		var group = this._exclusives[g];
		
		for(var i = 0; i &lt; group.length; i++) {
			if(s.match(group[i])) return true;
		}
		
		return false;
	},

	
	/**
	 * Отключение состояния
	 *  
	 * @param {String} from имя состояния
	 * @returns {$.Deferred}
	 */
	unset: function(from) {
		
		// Если состояние не установлено, то ничего не делаем
		if(from && !(from in this._current)) {
			return $.when({});			
		}
		
		var self = this;
		var transitions = this._transitions;
		var states = this._states; //this._widget.options.states;
		
		var to = [];
		
		// 1. Вызываем 
		var def = null;
		var deferreds = [];
		
		for(var i = 0; i &lt; transitions.length; i++) {
			var t = transitions[i];
			if(t.from == from && t.to) {
				var result = t.action.call(this._widget);
				// Если результат является Deferred-объектом, то сохраняем его в цепочку
//				if(result && result.done)
//					deferred = $.when(result);
				deferreds.push(result);
				
				to.push(t.to);
			}
			else if(t.from == from && t.to == '*') {
				def = t;
			}
		}
		// for(var i in transitions[from]) {
			// transitions[from][i].call(this._widget);
			// to.push(i);
		// }
		
		if(to.length == 0 && def) {
			var result = def.action.call(this._widget);
			
			deferreds.push(result);
			// //FIXME
			// if(result && result.done)
				// deferred = $.when(result);
		}
		


		// 2. 
		for(var i = 0; i &lt; to.length; i++) {
			self._current[to[i]] = [from];
			if(to[i] in states) self._state_on(to[i]); //states[to[i]].call(self._widget);
		}
		
		// 3.
		self._state_off(from);
		
		delete self._current[from];		
		

		// 3.
//		this.state_off(from);
		

		
		//FIXME хак, если Deferred не определен
		// if(deferred == null) {
			// deferred = $.Deferred();
			// deferred.resolve();
		// }
		
		
		// deferred.done(function() {
// 			
		// });
		
		
//		return deferred;
		return $.when.apply($, deferreds);
	},
	
	
	
	/**
	 * Переключение состояния
	 *  
	 * Состояние устанавливается, если флаг равен true и отключается, если флаг false
	 * 
	 * @param {String} name имя состояния
	 * @param {boolean} sw флаг переключения
	 */
	toggle: function(name, sw) {
		
		if(arguments.length == 1) sw = !this.is(name);
		
		return sw ? this.set(name) : this.unset(name);

//		return this;
	},
	
	
	
	/**
	 * Установка состояния и отключение других состояний, попадающих под шаблон
	 * 
	 * @deprecated
	 * 
	 * @param {String} name имя состояния
	 * @param {Array|String|RegExp} unset_template шаблон
	 */
	only: function(name, unset_template) {

		var states_to_unset = [];

		if(unset_template) {
			
			if($.isArray(unset_template))
				states_to_unset = unset_template;
			else {
				if($.isString(unset_template))
					unset_template = new RegExp('^'+unset_template+'.*$');
				
				for(var i in this._current)
					if(i.match(unset_template)) states_to_unset.push(i);				
			}
		}
		else {
			for(var i in this._current)
				if(i != name) states_to_unset.push(i);
		}

		// очищаем состояния, выбранные для удаления
		for(var i = 0; i &lt; states_to_unset.length; i++) 
			this.unset(states_to_unset[i]);

		// если состояние еще не установлено, то устанавливаем его
		if(!this.is(name))
			this.set(name);	
		
		return this;		
	},	
	
	
	
	/**
	 * Очистка всех состояний
	 *  
	 */
	clear: function() {
		this._current = {};
		return this;
	},
	
	
	/**
	 * Проверка, установлено ли состояние
	 *  
	 * @param {String} name имя состояния
	 */
	is: function(name) {
		return (name in this._current);
	}
	
	
	
});











/**
 * Плагин, добавляющий StateManager к объекту
 *
 * @mixin  
 */
Ergo.Statable = function(o) {
	this.states = new Ergo.core.StateManager(this);
	
//	var o = this.options;
	var self = this;
	
	if('states' in o){
		for(var i in o.states)
			this.states.state(i, o.states[i]);
		// настраиваем особое поведение состояния hover
		if('hover' in o.states){
			this.el.hover(function(){ self.states.set('hover'); }, function(){ self.states.unset('hover'); });
		}
	}
	
	if('transitions' in o) {
		for(var i in o.transitions) {
			var t = o.transitions[i];
			if($.isPlainObject(t)) {
				//TODO
			}
			else {
				var a = i.split('>');
				if(a.length == 1) a.push('');
				this.states.transition($.trim(a[0]) || '*', $.trim(a[1]) || '*', t);					
			}
		}
	}
	
	
};










</pre>
        </article>
    </section>





				</div>

				<div class="clearfix"></div>
				<footer>
					
					
		<span class="jsdoc-message">
		Documentation generated by <a href="https://github.com/jsdoc3/jsdoc">JSDoc 3.2.2</a>
		on Fri Nov 14 2014 01:28:09 GMT+0400 (MSK) using the <a href="https://github.com/terryweiss/docstrap">DocStrap template</a>.
		</span>
				</footer>
			</div>

			
			<br clear="both">
		</div>

	</div>
	<script src="scripts/sunlight.js"></script>
	<script src="scripts/sunlight.javascript.js"></script>
	<script src="scripts/sunlight-plugin.doclinks.js"></script>
	<script src="scripts/sunlight-plugin.linenumbers.js"></script>
	<script src="scripts/sunlight-plugin.menu.js"></script>
	<script src="scripts/jquery.min.js"></script>
	<script src="scripts/jquery.scrollTo.js"></script>
	<script src="scripts/jquery.localScroll.js"></script>
	<script src="scripts/bootstrap-dropdown.js"></script>
	<script src="scripts/toc.js"></script>


	<script>  Sunlight.highlightAll({lineNumbers:,  showMenu: true, enableDoclinks :true}); </script>

	<script>
		$( function () {
			$( "#toc" ).toc( {
				selectors   : "h1,h2,h3,h4",
				showAndHide : false,
				scrollTo    : 60
			} );
			$( "#toc>ul" ).addClass( "nav nav-pills nav-stacked" );
			$( "#main span[id^='toc']" ).addClass( "toc-shim" );

		} );
	</script>

	

</body>
</html>
